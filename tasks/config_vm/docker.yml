---
- name: Configure docker
  hosts: docker
  gather_facts: no 
  become: True
  tasks:

  - name: Create docker-compose.yml for "{{ inventory_hostname }}"
    ansible.builtin.template:
      src: ../../templates/docker/docker-compose.yml.j2
      dest: /tmp/docker-compose.yml
      owner: root
      group: root
      mode: '1777'

  - name: Wait for /var/lib/dpkg/lock-frontend to be released 
    ansible.builtin.shell: while lsof /var/lib/dpkg/lock-frontend ; do sleep 10; done;

  - name: Install Docker
    ansible.builtin.apt: 
      name: 
       - docker
       - docker-compose 
      update_cache: no 
    register: apt_res
    retries: 5
    until: apt_res is success
    async: 60
    poll: 60

  # use files parameter to use multiple docker-compose.yml files
  - name: Deploy Docker Compose stack
    community.docker.docker_compose:
      project_src: /tmp/
      files:
      - docker-compose.yml
#      - docker-compose.prod.yml
